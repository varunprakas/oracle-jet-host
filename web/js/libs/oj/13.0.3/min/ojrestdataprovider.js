/**
 * @license
 * Copyright (c) 2014, 2022, Oracle and/or its affiliates.
 * Licensed under The Universal Permissive License (UPL), Version 1.0
 * as shown at https://oss.oracle.com/licenses/upl/
 * @ignore
 */
define(["exports","ojs/ojeventtarget","ojs/ojdataprovider","ojs/ojset","ojs/ojmap","ojs/ojmetadatautils"],function(t,e,s,r,i,a){"use strict";r=r&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r,i=i&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i;
/**
     * @preserve Copyright 2013 jQuery Foundation and other contributors
     * Released under the MIT license.
     * http://jquery.org/license
     */
var n=function(t,e,s,r){return new(s||(s=Promise))(function(i,a){function n(t){try{h(r.next(t))}catch(t){a(t)}}function o(t){try{h(r.throw(t))}catch(t){a(t)}}function h(t){var e;t.done?i(t.value):(e=t.value,e instanceof s?e:new s(function(t){t(e)})).then(n,o)}h((r=r.apply(t,e||[])).next())})};class o{constructor(t){this.options=t}fetch(){return n(this,void 0,void 0,function*(){const t=yield this._createRequest(),e=yield fetch(t);return this._parseResponse(e)})}_createRequest(){return n(this,void 0,void 0,function*(){const{url:t,transforms:e,fetchParameters:s,fetchType:r,fetchOptions:i}=this.options,n=e[r].request;if(n){return n(a.deepFreeze({url:t,fetchParameters:s,fetchType:r,fetchOptions:i}))}return new Request(t)})}_parseResponse(t){return n(this,void 0,void 0,function*(){const e={status:t.status,headers:t.headers,body:yield this._getResponseBody(t)};if(!t.ok)throw e;return this._applyResponseTransforms(e)})}_getResponseBody(t){return n(this,void 0,void 0,function*(){try{return yield t.json()}catch(t){return}})}_applyResponseTransforms({status:t,headers:e,body:s}){return n(this,void 0,void 0,function*(){const{transforms:r={},fetchType:i}=this.options,n=r[i].response;let o,h,c,f,u;if(n){const r=a.deepFreeze({status:t,headers:e,body:s}),i=yield n(r);o=i.data,h=i.keys,c=i.metadata,f=i.hasMore,u=i.totalSize}else null!==s&&"object"==typeof s&&(o=s.data,h=s.keys,c=s.metadata,f=s.hasMore,u=s.totalSize);if(!Array.isArray(o))throw'"data" should be an array. Please use the response transform to extract the data array from the response if needed.';return{data:o,keys:h,metadata:c,hasMore:f,totalSize:u}})}}var h=function(t,e,s,r){return new(s||(s=Promise))(function(i,a){function n(t){try{h(r.next(t))}catch(t){a(t)}}function o(t){try{h(r.throw(t))}catch(t){a(t)}}function h(t){var e;t.done?i(t.value):(e=t.value,e instanceof s?e:new s(function(t){t(e)})).then(n,o)}h((r=r.apply(t,e||[])).next())})};class c{constructor(t){var e;this.options=t,this._totalSize=-1,this._sequenceNum=0,this._mapClientIdToProps=new Map,this.AsyncIterable=(e=class{constructor(t){this._asyncIterator=t,this[Symbol.asyncIterator]=function(){return this._asyncIterator}}},Symbol.asyncIterator,e),this.AsyncIterator=class{constructor(t,e,s,r,i){this._parent=t,this._nextFunc=e,this._fetchParameters=s,this._offset=r,this._iterationLimit=i,this._rowsFetched=0,this._clientId=s&&s.clientId||Symbol(),t._mapClientIdToProps.set(this._clientId,{hasMore:!0,offset:r})}next(){return h(this,void 0,void 0,function*(){const t=this._parent._mapClientIdToProps.get(this._clientId),e=t.offset,s=t.hasMore,{result:r,offset:i,hasNoMore:a}=yield this._nextFunc("fetchFirst",this._fetchParameters,e,s);this._parent._mapClientIdToProps.set(this._clientId,{hasMore:!a,offset:i});const n=r.value.data;return this._rowsFetched+=n.length,Number.isInteger(this._iterationLimit)&&this._rowsFetched>=this._iterationLimit&&(r.done=!0),r})}},this.AsyncIteratorYieldResult=class{constructor(t){this.value=t,this.done=!1}},this.AsyncIteratorReturnResult=class{constructor(t){this.value=t,this.done=!0}}}fetchFirst(t){return new this.AsyncIterable(new this.AsyncIterator(this,this._fetchFrom.bind(this),t,0,this.options.iterationLimit))}fetchByKeys(t){return h(this,void 0,void 0,function*(){if(!t)throw Error('"keys" is a required parameter');const e=this._getCapabilitiesFromOptions();if(e.fetchByKeys){if("lookup"===e.fetchByKeys.implementation)return this._fetchByKeysLookup(t);if("batchLookup"===e.fetchByKeys.implementation)return this._fetchByKeysBatchLookup(t)}return this._fetchByKeysIteration(t)})}fetchByOffset(t){return h(this,void 0,void 0,function*(){if(!t)throw Error('"offset" is a required parameter');const e=t.offset>0?t.offset:0,s=this._getCapabilitiesFromOptions();return s.fetchByOffset&&"randomAccess"===s.fetchByOffset.implementation?this._fetchByOffsetRandomAccess(t,e):this._fetchByOffsetIteration(t,e)})}containsKeys(t){return h(this,void 0,void 0,function*(){const e=new r,s=yield this.fetchByKeys(t);return t.keys.forEach(t=>{null!=s.results.get(t)&&e.add(t)}),{containsParameters:t,results:e}})}createOptimizedKeySet(t){return t?new r(t):new r}createOptimizedKeyMap(t){return t?new i(t):new i}isEmpty(){return"unknown"}getCapability(t){const e=this._getCapabilitiesFromOptions();switch(t){case"sort":return e.sort;case"filter":return e.filter;case"fetchFirst":return this._getFetchCapability("fetchFirst");case"fetchByKeys":return this._getFetchCapability("fetchByKeys");case"fetchByOffset":return this._getFetchCapability("fetchByOffset");case"fetchCapability":return c._getFetchCapabilityDefaults();default:return}}getTotalSize(){return Promise.resolve(this._totalSize)}refresh(){this.dispatchEvent(new s.DataProviderRefreshEvent)}mutate(t){const{add:e,remove:r}=t;this._adjustIteratorOffset(r,e),this.dispatchEvent(new s.DataProviderMutationEvent(t))}_fetchFrom(t,e,r,i){return h(this,void 0,void 0,function*(){if(i){const i=this._convertFetchListToFetchByOffsetParameters(e,r),a=this._getFetchSize(i),n=Object.assign(Object.assign({},i),{size:a,filterCriterion:s.FilterFactory.getFilter({filterDef:i.filterCriterion,filterOptions:this.options})}),h=new o({fetchType:t,fetchParameters:n,url:this.options.url,transforms:this.options.transforms,fetchOptions:{textFilterAttributes:this.options.textFilterAttributes}}),c=yield h.fetch(),{data:f,totalSize:u,hasMore:l}=c;let d;if(c.metadata)d=c.metadata.map(t=>Object.assign({},t));else{const t=c.keys||this._generateKeysFromData(f);d=this._generateMetadataFromKeys(t)}const y=this._mergeSortCriteria(e.sortCriteria);y&&(e.sortCriteria=y);const p={fetchParameters:e,data:f,metadata:d};return Number.isInteger(u)&&this._totalSize!==u&&(this._totalSize=u),"boolean"==typeof l&&(l||f.length>0)?{result:new this.AsyncIteratorYieldResult(p),offset:r+f.length,hasNoMore:!l}:{result:new this.AsyncIteratorReturnResult(p),offset:r+f.length,hasNoMore:!l}}return{result:new this.AsyncIteratorReturnResult({fetchParameters:e,data:[],metadata:[]}),offset:r,hasNoMore:!0}})}_fetchByKeysIteration(t){return h(this,void 0,void 0,function*(){const e=this._convertFetchByKeysToFetchListParameters(t),s=this.fetchFirst(e)[Symbol.asyncIterator](),r=[],i=[];let a=!1;for(;!a;){const e=yield s.next(),{data:n,metadata:o}=e.value;o.forEach((e,s)=>{t.keys.has(e.key)&&(r.push(n[s]),i.push(e))}),a=t.keys.size===i.length||e.done}return this._createFetchByKeysResults(t,r,i)})}_fetchByKeysLookup(t){return h(this,void 0,void 0,function*(){const e=[],s=[],r=[];for(let s of t.keys){const r=new o({fetchType:"fetchByKeys",fetchParameters:Object.assign(Object.assign({},t),{keys:new Set([s])}),url:this.options.url,transforms:this.options.transforms});e.push(r.fetch())}return(yield Promise.all(e)).forEach(t=>{t.data.forEach(t=>{s.push(t)});const e=t.keys||this._generateKeysFromData(t.data);(t.metadata||this._generateMetadataFromKeys(e)).forEach(t=>{r.push(t)})}),this._createFetchByKeysResults(t,s,r)})}_fetchByKeysBatchLookup(t){return h(this,void 0,void 0,function*(){const e=new o({fetchType:"fetchByKeys",fetchParameters:t,url:this.options.url,transforms:this.options.transforms}),s=yield e.fetch(),r=s.keys||this._generateKeysFromData(s.data),i=s.metadata||this._generateMetadataFromKeys(r);return this._createFetchByKeysResults(t,s.data,i)})}_fetchByOffsetRandomAccess(t,e){return h(this,void 0,void 0,function*(){const s=yield this._fetchFrom("fetchByOffset",this._convertFetchByOffsetToFetchListParameters(t),e,!0),{value:r,done:i}=s.result,{data:a,metadata:n}=r,o=a.map((t,e)=>({metadata:n[e],data:t}));return{fetchParameters:t,results:o,done:i}})}_fetchByOffsetIteration(t,e){return h(this,void 0,void 0,function*(){const s=this._convertFetchByOffsetToFetchListParameters(t),r=this.fetchFirst(s)[Symbol.asyncIterator](),i=[],a=[],n=this._getFetchSize(t);let o=!1,h=!0;for(;!o;){const t=yield r.next(),s=t.value,{data:c,metadata:f}=s;h=t.done,c.forEach(t=>{i.push(t)}),f.forEach(t=>{a.push(t)}),o=void 0!==i[e+n-1]||h}const c=e,f=e+n,u=i.slice(c,f),l=a.slice(c,f),d=u.map((t,e)=>({metadata:l[e],data:t}));return{fetchParameters:t,results:d,done:h}})}_generateKeysFromData(t){const e=null!=this.options?this.options.keyAttributes:null;return t.map(t=>{let s=this._getId(t);return null!=s&&"@index"!=e||(s=this._sequenceNum++),s})}_generateMetadataFromKeys(t){return t.map(t=>({key:t}))}_getId(t){let e,s=null;if(null!=this.options&&null!=this.options.keyAttributes&&(s=this.options.keyAttributes),null!=s){if(Array.isArray(s)){let r;for(e=[],r=0;r<s.length;r++)e[r]=this._getVal(t,s[r])}else e=this._getVal(t,s);return e}return null}_getVal(t,e){const s=e.indexOf(".");if(s>0){const r=e.substring(0,s),i=e.substring(s+1),a=t[r];if(a)return this._getVal(a,i)}return"function"==typeof t[e]?t[e]():t[e]}_convertFetchByOffsetToFetchListParameters(t){return{size:t.size,sortCriteria:t.sortCriteria,filterCriterion:t.filterCriterion,attributes:t.attributes,clientId:t.clientId}}_convertFetchListToFetchByOffsetParameters(t,e){return{offset:e,size:t.size,sortCriteria:t.sortCriteria,filterCriterion:t.filterCriterion,attributes:t.attributes,clientId:t.clientId}}_convertFetchByKeysToFetchListParameters(t){return{attributes:t.attributes}}_createFetchByKeysResults(t,e,s){const r=new Map;return e.forEach((t,e)=>{t&&r.set(s[e].key,{metadata:s[e],data:t})}),{fetchParameters:t,results:r}}_getFetchCapability(t){const e=this._getCapabilitiesFromOptions(),s=c._getFetchCapabilityDefaults();return"fetchFirst"===t?Object.assign(Object.assign({},s),{iterationSpeed:"delayed"}):e[t]?Object.assign(Object.assign({},s),e[t]||{}):null}static _getFetchCapabilityDefaults(){return{caching:"none",attributeFilter:{expansion:{},ordering:{},defaultShape:{features:new Set(["exclusion"])}}}}_getCapabilitiesFromOptions(){return this.options.capabilities||{}}_getFetchSize(t){return Number.isInteger(t.size)&&t.size>0?t.size:25}_mergeSortCriteria(t){const e=null!=this.options?this.options.implicitSort:null;if(null!=e){if(null==t)return e;const s=t.slice(0);let r,i,a;for(r=0;r<e.length;r++){for(a=!1,i=0;i<s.length;i++)s[i].attribute==e[r].attribute&&(a=!0);a||s.push(e[r])}return s}return t}_adjustIteratorOffset(t,e){const s=t?t.indexes:null,r=e?e.indexes:null;this._mapClientIdToProps.forEach((t,e)=>{let i=t.offset,a=0;s&&s.forEach(function(t){t<i&&++a}),i-=a;let n=!1;r&&r.forEach(function(t){t<i?++i:n=!0}),n?this._mapClientIdToProps.set(e,{hasMore:!0,offset:i}):this._mapClientIdToProps.set(e,{hasMore:t.hasMore,offset:i})})}}e.EventTargetMixin.applyMixin(c),t.RESTDataProvider=c,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=ojrestdataprovider.js.map