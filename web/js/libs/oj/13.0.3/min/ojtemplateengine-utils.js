/**
 * @license
 * Copyright (c) 2014, 2022, Oracle and/or its affiliates.
 * Licensed under The Universal Permissive License (UPL), Version 1.0
 * as shown at https://oss.oracle.com/licenses/upl/
 * @ignore
 */
define(["exports","preact","ojs/ojcore-base","ojs/ojcustomelement-utils","ojs/ojmetadatautils","ojs/ojlogger"],function(e,t,s,o,n,r){"use strict";s=s&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s;const i=Symbol("row");class a{static renderNodes(e,s,n=!1){const r=s.parentStub;let c=()=>Array.from(r.childNodes);s.nodes&&(c=a._getRetrieveNodesFunction(s.nodes)),t.render(e,r);const l=c();l.forEach(e=>{e.setAttribute&&e.setAttribute("data-oj-vdom-template-root",""),e[i]=s,e[o.CACHED_BINDING_PROVIDER]="preact",e[o.CACHED_USE_KO_FLAG]=n}),s.vnode=e,s.nodes=l}static clean(e){var s;const o=e[i];if(!o.cleaned){o.cleaned=!0;const e=a._getInsertNodesFunction(o.nodes);t.render(null,o.parentStub),e(o.nodes),null===(s=o.computedVNode)||void 0===s||s.dispose();const n=o.template,r=n._cachedRows.indexOf(o);n._cachedRows.splice(r,1)}}static _getInsertNodesFunction(e){const t=e[e.length-1],s=t.parentNode,o=t.nextSibling;return e=>{e.forEach(e=>s.insertBefore(e,o))}}static _getRetrieveNodesFunction(e){const t=e[0],s=e[e.length-1],o=t.parentNode,n=t.previousSibling,r=s.nextSibling;return()=>{const e=[];for(let t=n?n.nextSibling:o.firstChild;t!==r;t=t.nextSibling)e.push(t);return e}}static resolveVDomTemplateProps(e,t,s,n,r,i,l){const d=o.CustomElementUtils.getPropertiesForElementTag(s),[u,p]=a.extendTemplate(e,a._COMPUTED_PROPS_CACHE_FACTORY,e=>{for(const t of u)t.recalculateValue(e)}),_=new c(e=>a._computeProps(e,s,d,n,r,l),t,i,p);return u.add(_),_}static _computeProps(e,t,s,r,i,a){const c=e(i),l=(Array.isArray(c)?c:[c]).find(e=>e.type===t);if(!l)throw new Error("Item template must contain an element named {elementTagName}");const d={},u=l.props;return Object.keys(u).forEach(e=>{r.has(e)&&(d[e]=o.transformPreactValue(null,n.getPropertyMetadata(e,s),l.props[e]))}),d}static extendTemplate(e,t,s){if(!e._cachedRows){let o=e.render;Object.defineProperties(e,{_cachedRows:{writable:!0,value:t()},render:{enumerable:!0,get:()=>o,set(e){o=e,e&&s(e)}}})}return e._cachedRows}}a._COMPUTED_PROPS_CACHE_FACTORY=()=>{const e=new Set;return[e,e.delete.bind(e)]},a._ROW_CACHE_FACTORY=()=>[];class c{constructor(e,t,s,o){this._calculate=e,this._defaultProps=s,this._disposeCallback=o,this._value=e(t),this._merged=this._getMergedValue(this._value)}peek(){return this._merged}subscribe(e){if(this._sub)throw new Error("Resolved property observable does not support multiple subscribers");this._sub=e}dispose(){this._disposeCallback(this)}recalculateValue(e){const t=this._calculate(e),o=this._value;this._value=t,this._sub&&!s.Object.compareValues(t,o)&&(this._merged=this._getMergedValue(t),this._sub(this._merged))}_getMergedValue(e){return Object.assign({},this._defaultProps,e)}}class l{static getContext(e,t,s,o,n,i){if(e){let a=s.__ojBindingContext?s.__ojBindingContext:e.__ContextFor(s);return a||(r.info("Binding context not found when processing template for element with id: "+t.id+". Using binding context for element instead."),a=e.__ContextFor(t)),e.__ExtendBindingContext(a,o,n,i,t)}const a={$current:o};return i&&(a[i]=o),a}static getResolvedDefaultProps(e,t,s){let o=e.get(t);if(!o){const n=document.createElement(t);o=l.getStaticPropertyMap(n,s,document.body),e.set(t,o)}return o}static getStaticPropertyMap(e,t,s){const o={};if(e){const n=e.style;n.display="none",n.position="absolute",e.setAttribute("data-oj-binding-provider","none"),s.appendChild(e),t.forEach(function(t){void 0!==e[t]&&(o[t]=e[t])}),s.removeChild(e)}return o}static createPropertyBackedByObservable(e,t,s,o,n){const r=e.__Observable(o);Object.defineProperty(t,s,{get:()=>r(),set:e=>{r(e),n&&n(e)},enumerable:!0})}}e.PreactTemplate=a,e.TemplateEngineUtils=l,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=ojtemplateengine-utils.js.map